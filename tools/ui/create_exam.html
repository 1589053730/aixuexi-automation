<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>创建试卷</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#165DFF',
            secondary: '#36CFC9',
            neutral: '#F5F7FA',
            dark: '#1D2129',
          },
          fontFamily: {
            inter: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .form-focus {
        @apply focus:ring-2 focus:ring-primary/30 focus:border-primary focus:outline-none;
      }
      .card-shadow {
        @apply shadow-lg shadow-primary/10;
      }
      .btn-hover {
        @apply hover:shadow-md hover:shadow-primary/20 hover:-translate-y-0.5 transition-all duration-200;
      }
      .resource-card-active {
        @apply border-primary bg-primary/5;
      }
    }
  </style>
</head>
<body class="bg-gray-50 font-inter text-dark min-h-screen flex flex-col">
  <main class="flex-grow container mx-auto px-4 py-8 md:py-12">
    <div class="max-w-2xl mx-auto">
      <div class="mb-8 text-center">
        <h2 class="text-[clamp(1.5rem,3vw,2.25rem)] font-bold text-dark mb-2">创建试卷</h2>
        <p class="text-gray-500">选择资源类型和题型，快速生成定制化生产数据</p>
      </div>
      
      <div class="bg-white rounded-xl p-6 md:p-8 card-shadow transition-all duration-300 hover:shadow-xl">
        <form id="resourceForm" class="space-y-8">
          <div class="form-group space-y-4">
            <p class="text-sm font-medium text-orange-600 bg-orange-50 p-3 rounded-lg border border-orange-200 flex items-center">
                <i class="fa fa-info-circle mr-2"></i>
                创建的试卷保存在‘测试专用公共云盘’的‘ui自动化测试文件夹’下
            </p>
            
            <h2 class="text-xl font-semibold text-dark flex items-center">
              <i class="fa fa-book text-primary mr-2"></i>
              选择学科
            </h2>
            
            <div class="relative">
              <select id="subject" name="subject" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all outline-none appearance-none">
                <option value="">请选择学科</option>
                <option value="初中语文">初中语文</option>
                <option value="初中数学">初中数学</option>
                <option value="初中物理">初中物理</option>
                <option value="初中化学">初中化学</option>
                <option value="小学英语">小学英语</option>
                <option value="小学数学">小学数学</option>
                <option value="小学语文">小学语文</option>
                <option value="高中数学">高中数学</option>
                <option value="高中化学">高中化学</option>
                <option value="高中物理">高中物理</option>
                <option value="初中英语">初中英语</option>
                <option value="初中科学">初中科学</option>
                <option value="初中生物">初中生物</option>
              </select>
              <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none text-gray-500">
                <i class="fa fa-chevron-down text-xs"></i>
              </div>
            </div>
          </div>

          <!-- 资源类型（试卷） -->
          <div class="form-group space-y-4">
            <h2 class="text-xl font-semibold text-dark flex items-center">
              <i class="fa fa-file-text-o text-primary mr-2"></i>
              试卷
            </h2>
            
            <p class="text-sm text-gray-600">请选择需要包含的题型</p>
            
            <div class="resource-type-card border-2 rounded-xl p-5 transition-all duration-300" data-type="exam">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <label class="flex items-center p-2 border border-gray-200 rounded-lg hover:bg-neutral/50 transition-colors cursor-pointer">
                  <input type="checkbox" name="examQuestionType" value="choice" 
                    class="w-4 h-4 text-primary form-focus rounded">
                  <span class="ml-2 text-gray-700 text-sm">选择题</span>
                </label>
                
                <label class="flex items-center p-2 border border-gray-200 rounded-lg hover:bg-neutral/50 transition-colors cursor-pointer">
                  <input type="checkbox" name="examQuestionType" value="fill" 
                    class="w-4 h-4 text-primary form-focus rounded">
                  <span class="ml-2 text-gray-700 text-sm">填空题</span>
                </label>
                
                <label class="flex items-center p-2 border border-gray-200 rounded-lg hover:bg-neutral/50 transition-colors cursor-pointer">
                  <input type="checkbox" name="examQuestionType" value="judge" 
                    class="w-4 h-4 text-primary form-focus rounded">
                  <span class="ml-2 text-gray-700 text-sm">判断题</span>
                </label>

                <label class="flex items-center p-2 border border-gray-200 rounded-lg hover:bg-neutral/50 transition-colors cursor-pointer">
                  <input type="checkbox" name="examQuestionType" value="answer" 
                    class="w-4 h-4 text-primary form-focus rounded">
                  <span class="ml-2 text-gray-700 text-sm">解答题</span>
                </label>

                <label class="flex items-center p-2 border border-gray-200 rounded-lg hover:bg-neutral/50 transition-colors cursor-pointer md:col-span-2">
                  <input type="checkbox" name="examQuestionType" value="comprehensive" 
                    class="w-4 h-4 text-primary form-focus rounded">
                  <span class="ml-2 text-gray-700 text-sm">综合题</span>
                </label>
              </div>
            </div>
          </div>

          <!-- 题目数量 -->
          <div class="form-group" id="questionCountGroup">
            <label for="questionCount" class="block text-sm font-medium text-gray-700 mb-2">
              题目数量 <span class="text-red-500">*</span>
            </label>
            <div class="relative">
              <input type="number" id="questionCount" name="questionCount" 
                    class="pl-4 w-full rounded-lg border border-gray-300 py-3 px-4 form-focus"
                    min="1" max="100" value="3" 
                    placeholder="请输入每种题型的题目数量（1-100）">
              <p class="mt-1 text-xs text-gray-500">注：该数量将应用于所有选中的题型</p>
            </div>
          </div>
          
          <button type="button" onclick="submitForm()" 
            class="w-full bg-primary text-white font-medium py-3 px-4 rounded-lg flex items-center justify-center space-x-2 btn-hover">
            <i class="fa fa-rocket"></i>
            <span>提交创建</span>
          </button>
        </form>
        
        <div id="result" class="mt-6 p-4 rounded-lg hidden transition-all duration-300"></div>
      </div>
    </div>
  </main>


  <script>
    

    document.querySelectorAll('.resource-type-card').forEach(card => {
      card.addEventListener('click', function(e) {
        if (e.target.type !== 'checkbox') {
          this.classList.toggle('resource-card-active');
        }
      });
    });

    // 复选框选中效果
    document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
      checkbox.addEventListener('change', function() {
        const label = this.closest('label');
        if (this.checked) {
          label.classList.add('border-primary', 'bg-primary/5');
          // 自动选中所在的资源类型卡片
          const card = this.closest('.resource-type-card');
          card.classList.add('resource-card-active');
        } else {
          label.classList.remove('border-primary', 'bg-primary/5');
        }
      });
    });

    async function submitForm() {
      const resultEl = document.getElementById('result');

      const subjectValue = document.getElementById('subject').value;

      // 验证学科选择
      if (!subjectValue) {
        showResult('<i class="fa fa-exclamation-circle mr-2"></i> 请选择学科', 'error');
        return;
      }

      // 获取选中的资源类型
      const cardTypes = Array.from(
        document.querySelectorAll('.resource-type-card.resource-card-active')
      ).map(card => card.dataset.type);

      // 验证题目数量
      const questionCount = parseInt(document.getElementById('questionCount').value);
      if (isNaN(questionCount) || questionCount < 1 || questionCount > 100) {
        showResult('<i class="fa fa-exclamation-circle mr-2"></i> 请输入有效的题目数量（1-100）', 'error');
        return;
      }

      // 获取选中的题型
      const questionTypes = {};
      if (cardTypes.includes('exam')) {
        questionTypes.exam = Array.from(
          document.querySelectorAll('input[name="examQuestionType"]:checked')
        ).map(el => el.value);
      }
      
      // 验证至少选择一种题型
      if (questionTypes.exam && questionTypes.exam.length === 0) {
          showResult('<i class="fa fa-exclamation-circle mr-2"></i> 请至少选择一种题型', 'error');
          return;
        }

      // 准备提交数据
      const createExamFormData = {
      createOptions: {  // 后端期望的数据包裹在createOptions中
          subject: subjectValue,  // 使用获取到的value
          questionTypes,
          questionCount
        }
      };

      // 显示加载状态
      showResult('<i class="fa fa-circle-o-notch fa-spin mr-2"></i> 正在创建试卷，请稍候...', 'loading');

      try {
        const controller = new AbortController();
        // 设置10分钟超时
        const timeoutId = setTimeout(() => controller.abort(), 600000);

        const response = await fetch('/api/create_exam', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(createExamFormData),
            signal: controller.signal
          });

        clearTimeout(timeoutId); 

        if (!response.ok) {
          throw new Error(`HTTP 错误: ${response.status}`);
        }

        const result = await response.json();
        
        if (result.success) {
          showResult(`<i class="fa fa-check-circle mr-2"></i> ${result.message}`, 'success');
        } else {
          showResult(`<i class="fa fa-exclamation-circle mr-2"></i> ${result.message}`, 'error');
        }
        
      } catch (err) {
        showResult(`<i class="fa fa-exclamation-circle mr-2"></i> 执行失败：${err.message}`, 'error');
      }
    }

    // 显示结果提示
    function showResult(message, type) {
      const resultEl = document.getElementById('result');
      resultEl.innerHTML = message;
      resultEl.classList.remove('hidden', 'bg-green-50', 'text-green-700', 'border', 'border-green-200',
                             'bg-red-50', 'text-red-700', 'border', 'border-red-200',
                             'bg-blue-50', 'text-blue-700', 'border', 'border-blue-200');
      
      switch(type) {
        case 'success':
          resultEl.classList.add('bg-green-50', 'text-green-700', 'border', 'border-green-200');
          break;
        case 'error':
          resultEl.classList.add('bg-red-50', 'text-red-700', 'border', 'border-red-200');
          break;
        case 'loading':
          resultEl.classList.add('bg-blue-50', 'text-blue-700', 'border', 'border-blue-200');
          break;
      }
    }
  </script>
</body>
</html>