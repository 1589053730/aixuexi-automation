<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>教研创建课程工具</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#165DFF',
            secondary: '#36CFC9',
            neutral: '#86909C',
            success: '#52C41A',
            warning: '#FAAD14',
            danger: '#FF4D4F',
            dark: '#1D2129',
            light: '#F2F3F5'
          },
          fontFamily: {
            inter: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .transition-height {
        transition: max-height 0.3s ease-in-out;
      }
      .scrollbar-thin {
        scrollbar-width: thin;
      }
      .scrollbar-thin::-webkit-scrollbar {
        width: 4px;
      }
      .scrollbar-thin::-webkit-scrollbar-thumb {
        background-color: rgba(156, 163, 175, 0.5);
        border-radius: 2px;
      }
      .status-running {
        color: #165DFF;
        font-weight: bold;
        animation: pulse 1.5s infinite;
      }
      @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.6; }
        100% { opacity: 1; }
      }
      .executing-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border: 2px solid rgba(22, 93, 255, 0.3);
        border-radius: 50%;
        border-top-color: #165DFF;
        animation: spin 1s ease-in-out infinite;
        margin-right: 6px;
      }
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
    }
  </style>
</head>
<body class="font-inter bg-gray-50 min-h-screen">
  <div class="container mx-auto px-4 py-8 max-w-5xl">
    <header class="mb-8 text-center">
      <h1 class="text-[clamp(1.8rem,4vw,2.5rem)] font-bold text-dark mb-2 flex items-center justify-center">
        <i class="fa fa-cloud-transfer text-primary mr-3"></i>
        创建课程 or 绑定配件
      </h1>
      <p class="text-neutral">1、生产中心复制文件夹   2、课程库绑定课程库</p>
    </header>

    <main class="bg-white rounded-xl shadow-lg p-6 md:p-8 mb-8">
      <form id="copyForm" class="space-y-8">

        <div class="space-y-4">
          <h2 class="text-xl font-semibold text-dark flex items-center">
            <i class="fa fa-cogs text-primary mr-2"></i>
            操作类型
          </h2>
          
          <div class="space-y-4 border border-gray-100 rounded-lg p-4 bg-light/50">
            <div class="flex items-start">
              <input type="radio" id="onlyCreateCourse" name="operationType" value="onlyCreate" checked
                class="mt-1 h-4 w-4 text-primary focus:ring-primary/50 border-gray-300">
              <div class="ml-3">
                <label for="onlyCreateCourse" class="block text-sm font-medium text-gray-700">只创建课程</label>
                <p class="text-xs text-neutral mt-1">请“选择学科”，输入“绑定课程讲次数量”、“选择课程库云盘”</p>
              </div>
            </div>
            
            <div class="flex items-start">
              <input type="radio" id="createAndBind" name="operationType" value="createAndBind"
                class="mt-1 h-4 w-4 text-primary focus:ring-primary/50 border-gray-300">
              <div class="ml-3">
                <label for="createAndBind" class="block text-sm font-medium text-gray-700">创建课程和绑定配件</label>
                <p class="text-xs text-neutral mt-1">请“选择学科”，输入“复制参数设置”、“源文件夹设置”、“目标文件夹设置”</p>
              </div>
            </div>
          </div>
        </div>

        <div class="space-y-4">
          <h2 class="text-xl font-semibold text-dark flex items-center">
            <i class="fa fa-book text-primary mr-2"></i>
            选择学科
          </h2>
          
          <div class="relative">
            <select id="subject" name="subject" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all outline-none appearance-none">
              <option value="">请选择学科</option>
              <option value="初中语文">初中语文</option>
              <option value="初中数学">初中数学</option>
              <option value="初中物理">初中物理</option>
              <option value="初中化学">初中化学</option>
              <option value="小学英语">小学英语</option>
              <option value="小学数学">小学数学</option>
              <option value="小学语文">小学语文</option>
              <option value="高中数学">高中数学</option>
              <option value="高中化学">高中化学</option>
              <option value="高中物理">高中物理</option>
              <option value="初中英语">初中英语</option>
              <option value="初中科学">初中科学</option>
              <option value="初中生物">初中生物</option>
            </select>
            <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none text-gray-500">
              <i class="fa fa-chevron-down text-xs"></i>
            </div>
          </div>
        </div>

        <div class="space-y-4 pt-4 border-t border-gray-100">
          <h2 class="text-xl font-semibold text-dark flex items-center">
            <i class="fa fa-list-ol text-primary mr-2"></i>
            课程讲次设置
          </h2>
          
          <div class="grid md:grid-cols-2 gap-6">
            <div class="space-y-2">
              <label class="block text-sm font-medium text-gray-700">请选择课程库云盘（对应 课程库-左侧课程）</label>
              <div class="relative">
                <select id="courseDrive" name="courseDrive" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all outline-none appearance-none">
                  <option value="">选择课程库位置</option>
                  <option value="测试专用课程">测试专用课程</option>
                  <option value="TSM课程">TSM课程</option>
                </select>
                <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none text-gray-500">
                  <i class="fa fa-chevron-down text-xs"></i>
                </div>
              </div>
            </div>

            <div class="space-y-2">
              <label class="block text-sm font-medium text-gray-700">绑定课程讲次数量</label>
              <div class="relative">
                <input type="number" id="courseLessonCount" name="courseLessonCount" min="1" value="1" 
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all outline-none">
                <div class="absolute inset-y-0 right-2 flex items-center pointer-events-none text-gray-500">
                  <i class="fa fa-hashtag text-xs"></i>
                </div>
              </div>
              <p class="text-xs text-neutral">对应“课程库-新建课程”页面的“讲次”字段</p>
            </div>
            
          </div>
        </div>

        <div class="space-y-4 pt-4 border-t border-gray-100">
          <h2 class="text-xl font-semibold text-dark flex items-center">
            <i class="fa fa-sliders text-primary mr-2"></i>
            复制参数设置
          </h2>
          
          <div class="grid md:grid-cols-2 gap-6">
            <div class="space-y-2">
              <label class="block text-sm font-medium text-gray-700">生产中心复制文件夹数量</label>
              <div class="relative">
                <input type="number" id="copyCount" name="copyCount" min="1" value="1" 
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all outline-none">
                <div class="absolute inset-y-0 right-2 flex items-center pointer-events-none text-gray-500">
                  <i class="fa fa-hashtag text-xs"></i>
                </div>
              </div>
              <p class="text-xs text-neutral">输入需要复制的文件夹数量，至少为1</p>
            </div>
          </div>
        </div>
        
        <div class="space-y-4">
          <h2 class="text-xl font-semibold text-dark flex items-center">
            <i class="fa fa-folder-open text-primary mr-2"></i>
            源文件夹设置
          </h2>
          
          <div class="grid md:grid-cols-2 gap-6">
            <div class="space-y-2">
              <label class="block text-sm font-medium text-gray-700">源云盘（想要复制的文件夹所在的云盘名称）</label>
              <div class="relative">
                <select id="sourceDrive" name="sourceDrive" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all outline-none appearance-none">
                  <option value="">选择源位置</option>
                  <option value="测试专用公共云盘">测试专用公共云盘</option>
                  <option value="TSM公共云盘">TSM公共云盘</option>
                </select>
                <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none text-gray-500">
                  <i class="fa fa-chevron-down text-xs"></i>
                </div>
              </div>
            </div>
            
            <div class="space-y-2">
              <label class="block text-sm font-medium text-gray-700">源文件夹路径</label>
              <div class="relative">
                <input type="text" id="sourcePath" name="sourcePath" placeholder="例如: /我的文件夹/第一讲" 
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all outline-none">
                <button type="button" id="browseSource" class="absolute right-2 top-1/2 -translate-y-1/2 text-primary hover:text-primary/80 transition-colors">
                  <i class="fa fa-search"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <div class="space-y-4 pt-4 border-t border-gray-100">
          <h2 class="text-xl font-semibold text-dark flex items-center">
            <i class="fa fa-folder-open-o text-secondary mr-2"></i>
            目标文件夹设置
          </h2>
          
          <div class="grid md:grid-cols-2 gap-6">
            <div class="space-y-2">
              <label class="block text-sm font-medium text-gray-700">目标云盘（文件夹复制到的云盘名称）</label>
              <div class="relative">
                <select id="targetDrive" name="targetDrive" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all outline-none appearance-none">
                  <option value="">选择目标位置</option>
                  <option value="测试专用公共云盘">测试专用公共云盘</option>
                  <option value="TSM公共云盘">TSM公共云盘</option>
                </select>
                <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none text-gray-500">
                  <i class="fa fa-chevron-down text-xs"></i>
                </div>
              </div>
            </div>
            
            <div class="space-y-2">
              <label class="block text-sm font-medium text-gray-700">目标文件夹路径</label>
              <div class="relative">
                <input type="text" id="targetPath" name="targetPath" placeholder="例如: /我的文件夹/第一讲" 
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all outline-none">
                <button type="button" id="browseTarget" class="absolute right-2 top-1/2 -translate-y-1/2 text-primary hover:text-primary/80 transition-colors">
                  <i class="fa fa-search"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <div class="flex justify-center pt-4 border-t border-gray-100">
          <button type="submit" id="copyButton" class="bg-primary hover:bg-primary/90 text-white font-medium px-8 py-3 rounded-lg transition-all transform hover:scale-[1.02] active:scale-[0.98] flex items-center">
            <i class="fa fa-copy mr-2"></i>
            提交
          </button>
        </div>
        <div id="status"></div>
      </form>
    </main>
    
    <div id="statusSection" class="bg-white rounded-xl shadow-lg p-6 mb-8 hidden">
      <h2 class="text-xl font-semibold text-dark mb-4 flex items-center">
        <i class="fa fa-spinner fa-spin mr-2" id="statusIcon"></i>
        <span id="statusTitle">复制操作准备中</span>
      </h2>
      
      <div class="bg-light rounded-lg p-4 h-48 overflow-y-auto scrollbar-thin mb-4">
        <pre id="executionLog" class="text-sm text-gray-700 whitespace-pre-wrap"></pre>
      </div>
      
      <div class="flex justify-end">
        <button id="cancelButton" class="hidden bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium px-4 py-2 rounded-lg transition-colors">
          <i class="fa fa-times mr-1"></i> 取消操作
        </button>
      </div>
    </div>
  </div>

  <div id="notification" class="fixed bottom-6 right-6 p-4 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 max-w-sm hidden"></div>

  <script>
   
    const copyForm = document.getElementById('copyForm');
    const subject = document.getElementById('subject'); 
    const sourceDrive = document.getElementById('sourceDrive');
    const sourcePath = document.getElementById('sourcePath');
    const targetDrive = document.getElementById('targetDrive');
    const targetPath = document.getElementById('targetPath');
    const browseSource = document.getElementById('browseSource');
    const browseTarget = document.getElementById('browseTarget');
    const sourcePreview = document.getElementById('sourcePreview');
    const statusSection = document.getElementById('statusSection');
    const statusTitle = document.getElementById('statusTitle');
    const statusIcon = document.getElementById('statusIcon');
    const executionLog = document.getElementById('executionLog');
    const copyButton = document.getElementById('copyButton');
    const cancelButton = document.getElementById('cancelButton');
    const notification = document.getElementById('notification');
    const historyList = document.getElementById('historyList');
    const copyCount = document.getElementById('copyCount');
    const courseLessonCount = document.getElementById('courseLessonCount');
    const courseDrive = document.getElementById('courseDrive');
    const operationTypeRadios = document.querySelectorAll('input[name="operationType"]');

    function toggleFormFields() {
      const selectedType = document.querySelector('input[name="operationType"]:checked').value;
      const isOnlyCreate = selectedType === 'onlyCreate';
      
      // 控制复制参数设置
      document.querySelector('h2:has(.fa-sliders)').closest('.space-y-4').style.display = isOnlyCreate ? 'none' : 'block';
      
      // 始终显示课程讲次设置（移除之前的条件判断）
      document.querySelector('h2:has(.fa-list-ol)').closest('.space-y-4').style.display = 'block';
      
      // 源文件夹设置和目标文件夹设置
      document.querySelector('h2:has(.fa-folder-open)').closest('.space-y-4').style.display = isOnlyCreate ? 'none' : 'block';
      document.querySelector('h2:has(.fa-folder-open-o)').closest('.space-y-4').style.display = isOnlyCreate ? 'none' : 'block';
    }

    // 为单选按钮添加事件监听
    operationTypeRadios.forEach(radio => {
      radio.addEventListener('change', toggleFormFields);
    });

    // 初始化时执行一次，设置初始显示状态
    toggleFormFields();
    
    browseSource.addEventListener('click', () => {
      if (!sourceDrive.value) {
        showNotification('请先选择源云盘', 'warning');
        return;
      }
      showNotification(`正在浏览 ${getDriveName(sourceDrive.value)}...`, 'info');
    });
    
    browseTarget.addEventListener('click', () => {
      if (!targetDrive.value) {
        showNotification('请先选择目标云盘', 'warning');
        return;
      }
      showNotification(`正在浏览 ${getDriveName(targetDrive.value)}...`, 'info');
    });
    
    copyForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // 验证表单
      if (!validateForm()) {
        return;
      }
            
      const statusElement = document.getElementById('status');
      statusElement.innerHTML = '<span class="executing-indicator"></span><span class="status-running">执行中，请稍候...</span>';
      statusElement.classList.add('p-3', 'bg-primary/5', 'rounded-lg', 'text-center');

      copyButton.disabled = true;
      copyButton.classList.add('opacity-70', 'cursor-not-allowed');
      cancelButton.classList.remove('hidden');
      
      const selectedType = document.querySelector('input[name="operationType"]:checked').value;
      const formData = {
        operationType: selectedType,
        subject: subject.value, 
        copyCount: parseInt(copyCount.value), 
        courseLessonCount: courseLessonCount.value,
        courseDrive: courseDrive.value,
        sourceDrive: sourceDrive.value,
        sourcePath: sourcePath.value,
        targetDrive: targetDrive.value,
        targetPath: targetPath.value,
        options: {
          overwrite: document.getElementById('overwrite')?.checked || false,
          includeSubfolders: document.getElementById('includeSubfolders')?.checked || false,
          copyPermissions: document.getElementById('copyPermissions')?.checked || false,
          notifyOnComplete: document.getElementById('notifyOnComplete')?.checked || false
        }
      };
      
      try {
        const controller = new AbortController();
        //设置5分钟超时
        const timeoutId = setTimeout(() => controller.abort(), 300000);

        const apiUrl = selectedType === 'onlyCreate' ? '/api/create_course' : '/api/copy-folder';
        // 根据操作类型选择不同的参数名称
        const requestBody = selectedType === 'onlyCreate' 
          ? { createOptions: formData } 
          : { copyOptions: formData };

        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(requestBody),
            signal: controller.signal
          });
        
        // const response = await fetch('/api/copy-folder', {
        //     method: 'POST',
        //     headers: {'Content-Type': 'application/json'},
        //     body: JSON.stringify({copyOptions: formData }),
        //     signal: controller.signal
        //   });

        clearTimeout(timeoutId); 

        if (!response.ok) {
          throw new Error(`HTTP 错误: ${response.status}`);
        }

        const result = await response.json();
        const statusElement = document.getElementById('status');
          statusElement.classList.remove('p-3', 'bg-primary/5', 'rounded-lg', 'text-center');
          statusElement.innerHTML = result.success 
            ? `<span class="text-success"><i class="fa fa-check-circle mr-1"></i> 执行完成: ${result.message}</span>` 
            : `<span class="text-danger"><i class="fa fa-exclamation-circle mr-1"></i> 失败: ${result.message}</span>`;
      } catch (error) {
        document.getElementById('status').textContent = '错误: ' + error.message;
      } finally {
        copyButton.disabled = false;
        copyButton.classList.remove('opacity-70', 'cursor-not-allowed');

      }
    });
    

    cancelButton.addEventListener('click', () => {
      if (confirm('确定要取消当前复制操作吗？')) {
        updateStatus('操作已被用户取消', 'warning');
        copyButton.disabled = false;
        copyButton.classList.remove('opacity-70', 'cursor-not-allowed');
        cancelButton.classList.add('hidden');
        showNotification('复制操作已取消', 'info');
      }
    });
    
    // 学科验证
    function validateForm() {
      if (!subject.value) { 
        showNotification('请选择学科', 'warning');
        return false;
      }

      if (!copyCount.value || isNaN(copyCount.value) || parseInt(copyCount.value) < 1) {
        showNotification('请输入有效的复制讲次数量（至少1）', 'warning');
        copyCount.focus();
        return false;
      }

      const selectedType = document.querySelector('input[name="operationType"]:checked').value;
      if (selectedType !== 'onlyCreate') {
        if (!copyCount.value || isNaN(copyCount.value) || parseInt(copyCount.value) < 1) {
          showNotification('请输入有效的复制讲次数量（至少1）', 'warning');
          copyCount.focus();
          return false;
        }

        // 验证课程讲次数量必须大于复制文件夹数量且差值大于1
        const lessonCount = parseInt(courseLessonCount.value);
        const folderCount = parseInt(copyCount.value);

        // 只需要保证讲次数量大于文件夹数量即可（允许等于文件夹数量+1）
        if (lessonCount < folderCount + 1) {
          showNotification(`“绑定课程讲次数量”（${lessonCount}）必须大于“生产中心复制文件夹数量”（${folderCount}）+1`, 'warning');
          courseLessonCount.focus();
          return false;
        }
        
        if (!sourceDrive.value) {
          showNotification('请选择源云盘', 'warning');
          return false;
        }
        
        if (!sourcePath.value.trim()) {
          showNotification('请输入源文件夹路径', 'warning');
          sourcePath.focus();
          return false;
        }
        
        if (!targetDrive.value) {
          showNotification('请选择目标云盘', 'warning');
          return false;
        }
        
        if (!targetPath.value.trim()) {
          showNotification('请输入目标文件夹路径', 'warning');
          targetPath.focus();
          return false;
        }
        
        if (sourceDrive.value === targetDrive.value && sourcePath.value.trim() === targetPath.value.trim()) {
          showNotification('源路径和目标路径不能相同', 'warning');
          return false;
        }
      }
      
      return true;
      
    }
    
    function updateStatus(message, type) {
      statusTitle.textContent = message;
      logToConsole(message);
      
      statusIcon.className = '';
      switch(type) {
        case 'info':
          statusIcon.className = 'fa fa-spinner fa-spin mr-2 text-primary';
          break;
        case 'success':
          statusIcon.className = 'fa fa-check-circle mr-2 text-success';
          break;
        case 'error':
          statusIcon.className = 'fa fa-exclamation-circle mr-2 text-danger';
          break;
        case 'warning':
          statusIcon.className = 'fa fa-exclamation-triangle mr-2 text-warning';
          break;
      }
    }
    
    function logToConsole(message) {
      const timestamp = new Date().toLocaleTimeString();
      executionLog.innerHTML += `[${timestamp}] ${message}\n`;
      executionLog.scrollTop = executionLog.scrollHeight;
    }
    
    function showNotification(message, type = 'info') {
      notification.textContent = message;
      notification.className = 'fixed bottom-6 right-6 p-4 rounded-lg shadow-lg transform transition-all duration-300 max-w-sm flex items-center';
      
      switch(type) {
        case 'success':
          notification.classList.add('bg-success/10', 'text-success', 'border', 'border-success/30');
          notification.innerHTML = `<i class="fa fa-check-circle mr-2"></i> ${message}`;
          break;
        case 'error':
          notification.classList.add('bg-danger/10', 'text-danger', 'border', 'border-danger/30');
          notification.innerHTML = `<i class="fa fa-exclamation-circle mr-2"></i> ${message}`;
          break;
        case 'warning':
          notification.classList.add('bg-warning/10', 'text-warning', 'border', 'border-warning/30');
          notification.innerHTML = `<i class="fa fa-exclamation-triangle mr-2"></i> ${message}`;
          break;
        default:
          notification.classList.add('bg-primary/10', 'text-primary', 'border', 'border-primary/30');
          notification.innerHTML = `<i class="fa fa-info-circle mr-2"></i> ${message}`;
      }
    }
    
    function getDriveName(value) {
      // 找到源云盘下拉列表中值为value的选项
      const sourceOption = Array.from(sourceDrive.options).find(option => option.value === value);
      if (sourceOption) {
        return sourceOption.text;
      }
      
      // 从目标云盘下拉列表中查找
      const targetOption = Array.from(targetDrive.options).find(option => option.value === value);
      if (targetOption) {
        return targetOption.text;
      }
      
      return value;
    }
    
    // 获取学科名称
    function getSubjectName(value) {
      const subjectNames = {
        'junior_chinese': '初中语文',
        'junior_math': '初中数学',
        'junior_physics': '初中物理',
        'junior_chemistry': '初中化学',
        'primary_english': '小学英语',
        'primary_math': '小学数学',
        'primary_chinese': '小学语文',
        'senior_math': '高中数学',
        'senior_chemistry': '高中化学',
        'senior_physics': '高中物理',
        'junior_english': '初中英语',
        'junior_science': '初中科学',
        'junior_biology': '初中生物'
      };
      return subjectNames[value] || value;
    }
  </script>
</body>
</html>